---
import { GITHUB_PROFILE_LINK } from '../consts';

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/blog', label: 'Blog' },
  { href: '/#projects', label: 'Projects' },
  { href: '/#contact', label: 'Contact' },
];

const themes = [
  { id: 'cloud', label: 'Light', icon: '‚òÄÔ∏è' },
  { id: 'cloud-dark', label: 'Dark', icon: 'üåô' },
  { id: 'terminal', label: 'Terminal', icon: 'üíª' },
];

const currentPath = Astro.url.pathname;
---

<header class="fixed top-0 left-0 right-0 z-50 border-b border-line bg-background/80 backdrop-blur-xl">
  <div class="container">
    <nav class="flex items-center justify-between h-16" aria-label="Main navigation">
      <!-- Logo -->
      <a
        href="/"
        class="group flex items-center gap-2 font-display font-semibold text-foreground"
        aria-label="Ivan Kalinichenko - Home"
      >
        <span class="text-accent font-mono text-sm">~/</span>
        <span class="tracking-tight">kalinichenko</span>
        <span class="text-foreground-tertiary font-mono text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200">.dev</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-1">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class:list={[
              "px-4 py-2 text-sm font-medium rounded-md transition-colors duration-150",
              currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href.replace('/#', '/')))
                ? "text-foreground bg-background-subtle"
                : "text-foreground-secondary hover:text-foreground hover:bg-background-subtle"
            ]}
          >
            {link.label}
          </a>
        ))}
      </div>

      <!-- Right Side: Theme Switcher + GitHub -->
      <div class="flex items-center gap-2">
        <!-- GitHub Link -->
        <a
          href={GITHUB_PROFILE_LINK}
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 text-foreground-tertiary hover:text-foreground transition-colors duration-150"
          aria-label="GitHub Profile"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>

        <!-- Theme Switcher -->
        <div class="relative">
          <button
            id="theme-toggle"
            type="button"
            class="flex items-center gap-1.5 px-2.5 py-1.5 text-sm text-foreground-tertiary hover:text-foreground border border-line rounded-md transition-colors duration-150 cursor-pointer hover:bg-background-subtle"
            aria-label="Change theme"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span id="theme-icon" class="text-base">‚òÄÔ∏è</span>
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <!-- Theme Dropdown -->
          <div
            id="theme-dropdown"
            class="absolute right-0 top-full mt-2 w-44 py-1.5 bg-surface border border-line rounded-lg shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 z-50"
            role="menu"
          >
            {themes.map((theme) => (
              <button
                type="button"
                class="theme-option w-full flex items-center gap-3 px-3 py-2 text-sm text-foreground-secondary hover:text-foreground hover:bg-background-subtle transition-colors cursor-pointer"
                data-theme={theme.id}
                role="menuitem"
              >
                <span class="text-base">{theme.icon}</span>
                <span>{theme.label}</span>
                <svg class="theme-check w-4 h-4 ml-auto text-accent opacity-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </button>
            ))}
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-toggle"
          type="button"
          class="md:hidden p-2 text-foreground-tertiary hover:text-foreground transition-colors duration-150 cursor-pointer"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Navigation -->
  <div
    id="mobile-menu"
    class="md:hidden hidden border-t border-line bg-background"
    aria-label="Mobile navigation"
  >
    <div class="container py-4 space-y-1">
      {navLinks.map((link) => (
        <a
          href={link.href}
          class:list={[
            "block px-4 py-3 text-sm font-medium rounded-md transition-colors duration-150",
            currentPath === link.href
              ? "text-foreground bg-background-subtle"
              : "text-foreground-secondary hover:text-foreground hover:bg-background-subtle"
          ]}
        >
          {link.label}
        </a>
      ))}
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-16" aria-hidden="true"></div>

<script is:inline>
  (function() {
    // Prevent multiple initializations
    if (window.__headerInitialized) return;
    window.__headerInitialized = true;

    // Theme configuration
    const THEMES = {
      'cloud': { icon: '‚òÄÔ∏è', label: 'Light' },
      'cloud-dark': { icon: 'üåô', label: 'Dark' },
      'terminal': { icon: 'üíª', label: 'Terminal' }
    };

    const DEFAULT_THEME = 'cloud';

    function getStoredTheme() {
      return localStorage.getItem('theme');
    }

    function getSystemPreference() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'cloud-dark' : 'cloud';
    }

    function updateThemeUI(theme) {
      // Update button icon
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon && THEMES[theme]) {
        themeIcon.textContent = THEMES[theme].icon;
      }

      // Update checkmarks in dropdown
      document.querySelectorAll('.theme-option').forEach(option => {
        const check = option.querySelector('.theme-check');
        if (check) {
          check.style.opacity = option.dataset.theme === theme ? '1' : '0';
        }
      });
    }

    function applyTheme(theme) {
      if (!THEMES[theme]) theme = DEFAULT_THEME;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeUI(theme);
    }

    function toggleDropdown(show) {
      const dropdown = document.getElementById('theme-dropdown');
      const toggle = document.getElementById('theme-toggle');
      if (!dropdown || !toggle) return;

      if (show) {
        dropdown.classList.remove('opacity-0', 'invisible', 'translate-y-1');
        dropdown.classList.add('opacity-100', 'visible', 'translate-y-0');
        toggle.setAttribute('aria-expanded', 'true');
      } else {
        dropdown.classList.add('opacity-0', 'invisible', 'translate-y-1');
        dropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
        toggle.setAttribute('aria-expanded', 'false');
      }
    }

    // Event delegation for all clicks
    document.addEventListener('click', (e) => {
      const themeToggle = e.target.closest('#theme-toggle');
      const themeDropdown = document.getElementById('theme-dropdown');
      const themeOption = e.target.closest('.theme-option');

      // Theme dropdown toggle
      if (themeToggle) {
        e.preventDefault();
        const isOpen = themeToggle.getAttribute('aria-expanded') === 'true';
        toggleDropdown(!isOpen);
        return;
      }

      // Theme option selection
      if (themeOption) {
        const newTheme = themeOption.dataset.theme;
        if (newTheme) {
          applyTheme(newTheme);
          toggleDropdown(false);
        }
        return;
      }

      // Close dropdown when clicking outside
      if (themeDropdown && !themeDropdown.contains(e.target)) {
        toggleDropdown(false);
      }

      // Mobile menu toggle
      const menuToggle = e.target.closest('#mobile-menu-toggle');
      if (menuToggle) {
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu) {
          const isOpen = !mobileMenu.classList.contains('hidden');
          mobileMenu.classList.toggle('hidden');
          menuToggle.setAttribute('aria-expanded', String(!isOpen));
        }
      }

      // Close mobile menu on link click
      const mobileMenuLink = e.target.closest('#mobile-menu a');
      if (mobileMenuLink) {
        const mobileMenu = document.getElementById('mobile-menu');
        const menuToggle = document.getElementById('mobile-menu-toggle');
        if (mobileMenu) mobileMenu.classList.add('hidden');
        if (menuToggle) menuToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // Close dropdown on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        toggleDropdown(false);
      }
    });

    // Initialize theme on page load
    function initTheme() {
      const storedTheme = getStoredTheme();
      const theme = storedTheme || getSystemPreference();
      applyTheme(theme);

      // Close mobile menu on navigation
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) mobileMenu.classList.add('hidden');

      // Close theme dropdown
      toggleDropdown(false);
    }

    initTheme();
    document.addEventListener('astro:after-swap', initTheme);
  })();
</script>
