---
import { AUTHOR_NAME, GITHUB_PROFILE_LINK } from '../consts';
import { ALL_THEME_OPTIONS, DEFAULT_LIGHT_THEME, DEFAULT_DARK_THEME } from '../config/themes';
import { NAV_LINKS } from '../config/navigation';

import GithubIcon from '../assets/icons/github.svg';
import CheckIcon from '../assets/icons/check.svg';
import MenuIcon from '../assets/icons/menu.svg';
import SunIcon from '../assets/icons/sun.svg';
import MoonIcon from '../assets/icons/moon.svg';
import TerminalIcon from '../assets/icons/terminal.svg';
import MonitorIcon from '../assets/icons/monitor.svg';

const themeIcons: Record<string, typeof SunIcon> = {
  sun: SunIcon,
  moon: MoonIcon,
  terminal: TerminalIcon,
  monitor: MonitorIcon,
};

const currentPath = Astro.url.pathname;
---

<header
  class="fixed top-0 left-0 right-0 z-50 border-b border-line bg-background/80 backdrop-blur-xl"
>
  <div class="container">
    <nav class="flex items-center justify-between h-14" aria-label="Main navigation">
      <!-- Logo with blinking cursor on hover -->
      <a
        href="/"
        class="group flex items-center gap-2 font-display font-semibold text-foreground"
        aria-label={`${AUTHOR_NAME} - Home`}
      >
        <span class="text-accent font-mono text-sm">~/</span>
        <span class="tracking-tight">kalinichenko</span>
        <span
          class="text-foreground-tertiary font-mono text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200"
          >.dev</span
        >
        <span
          class="font-mono text-accent opacity-0 group-hover:opacity-100 transition-opacity duration-200 cursor-blink-inline"
          aria-hidden="true"></span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-1">
        {
          NAV_LINKS.map((link) => (
            <a
              href={link.href}
              class:list={[
                'px-3 py-1.5 text-sm font-medium rounded-md transition-colors duration-150',
                currentPath === link.href ||
                (!link.href.startsWith('/#') &&
                  link.href !== '/' &&
                  (currentPath === link.href + '/' || currentPath.startsWith(link.href + '/')))
                  ? 'text-foreground bg-background-subtle'
                  : 'text-foreground-secondary hover:text-foreground hover:bg-background-subtle',
              ]}
            >
              {link.label}
            </a>
          ))
        }
      </div>

      <!-- Right Side: Keyboard Badge + Theme Switcher + GitHub -->
      <div class="flex items-center gap-1">
        <!-- Keyboard Shortcut Badge (hidden on mobile) -->
        <button
          type="button"
          id="shortcuts-badge"
          class="hidden lg:flex kbd-badge cursor-pointer hover:border-foreground-tertiary transition-colors"
          aria-label="Show keyboard shortcuts"
          title="Keyboard shortcuts"
        >
          <span id="mod-key">âŒ˜</span>K
        </button>

        <!-- GitHub Link with icon hover effect -->
        <a
          href={GITHUB_PROFILE_LINK}
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 text-foreground-tertiary hover:text-foreground transition-colors duration-150"
          aria-label="GitHub Profile"
        >
          <GithubIcon class="w-5 h-5 icon-hover" />
        </a>

        <!-- Theme Switcher -->
        <div class="relative">
          <button
            id="theme-toggle"
            type="button"
            class="p-2 text-foreground-tertiary hover:text-foreground rounded-md transition-colors duration-150 cursor-pointer hover:bg-background-subtle"
            aria-label="Change theme"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <MonitorIcon class="w-5 h-5 theme-icon" data-icon="monitor" />
            <SunIcon class="w-5 h-5 theme-icon hidden" data-icon="sun" />
            <MoonIcon class="w-5 h-5 theme-icon hidden" data-icon="moon" />
            <TerminalIcon class="w-5 h-5 theme-icon hidden" data-icon="terminal" />
          </button>

          <!-- Theme Dropdown -->
          <div
            id="theme-dropdown"
            class="absolute right-0 top-full mt-2 w-40 py-1.5 bg-surface border border-line rounded-lg shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 z-50"
            role="menu"
          >
            {
              ALL_THEME_OPTIONS.map((theme) => {
                const IconComponent = themeIcons[theme.iconId];
                return (
                  <button
                    type="button"
                    class="theme-option w-full flex items-center gap-3 px-3 py-2 text-sm text-foreground-secondary hover:text-foreground hover:bg-background-subtle transition-colors cursor-pointer"
                    data-theme={theme.id}
                    role="menuitem"
                  >
                    <IconComponent class="w-4 h-4" />
                    <span>{theme.label}</span>
                    <CheckIcon class="theme-check w-4 h-4 ml-auto text-accent opacity-0" />
                  </button>
                );
              })
            }
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-toggle"
          type="button"
          class="md:hidden p-2 text-foreground-tertiary hover:text-foreground transition-colors duration-150 cursor-pointer"
          aria-label="Open menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <MenuIcon class="w-5 h-5" />
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Navigation -->
  <div
    id="mobile-menu"
    class="md:hidden hidden border-t border-line bg-background"
    aria-label="Mobile navigation"
  >
    <div class="container py-4 space-y-1">
      {
        NAV_LINKS.map((link) => (
          <a
            href={link.href}
            class:list={[
              'block px-4 py-2.5 text-sm font-medium rounded-md transition-colors duration-150',
              currentPath === link.href
                ? 'text-foreground bg-background-subtle'
                : 'text-foreground-secondary hover:text-foreground hover:bg-background-subtle',
            ]}
          >
            {link.label}
          </a>
        ))
      }
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-14" aria-hidden="true"></div>

<style>
  .cursor-blink-inline::after {
    content: '|';
    animation: blink-cursor 1s step-end infinite;
  }

  @keyframes blink-cursor {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }
</style>

<script>
  import {
    ALL_THEME_OPTIONS,
    THEMES,
    DEFAULT_LIGHT_THEME,
    DEFAULT_DARK_THEME,
  } from '../config/themes';

  const THEME_MAP = Object.fromEntries(
    THEMES.map((t) => [t.id, { iconId: t.iconId, label: t.label }])
  );

  const ALL_OPTIONS_MAP = Object.fromEntries(
    ALL_THEME_OPTIONS.map((t) => [t.id, { iconId: t.iconId, label: t.label }])
  );

  // Update modifier key display for Windows/Mac
  const modKeyEl = document.getElementById('mod-key');
  if (modKeyEl && !navigator.platform.includes('Mac')) {
    modKeyEl.textContent = 'Ctrl+';
  }

  // Handle shortcuts badge click
  const shortcutsBadge = document.getElementById('shortcuts-badge');
  if (shortcutsBadge) {
    shortcutsBadge.addEventListener('click', () => {
      // Dispatch keyboard event to trigger shortcuts hint
      const event = new KeyboardEvent('keydown', {
        key: 'k',
        metaKey: navigator.platform.includes('Mac'),
        ctrlKey: !navigator.platform.includes('Mac'),
        bubbles: true,
      });
      document.dispatchEvent(event);
    });
  }

  function getStoredPreference(): string {
    return localStorage.getItem('theme') || 'auto';
  }

  function resolvePreference(pref: string): string {
    if (pref === 'auto') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? DEFAULT_DARK_THEME
        : DEFAULT_LIGHT_THEME;
    }
    return THEME_MAP[pref] ? pref : DEFAULT_LIGHT_THEME;
  }

  function updateThemeUI(preference: string) {
    // Show the icon for the preference (auto shows monitor, not sun/moon)
    const optionConfig = ALL_OPTIONS_MAP[preference];
    if (optionConfig) {
      document.querySelectorAll('.theme-icon').forEach((icon) => {
        if ((icon as HTMLElement).dataset.icon === optionConfig.iconId) {
          icon.classList.remove('hidden');
        } else {
          icon.classList.add('hidden');
        }
      });
    }

    // Update checkmarks in dropdown
    document.querySelectorAll('.theme-option').forEach((option) => {
      const check = option.querySelector('.theme-check') as HTMLElement | null;
      if (check) {
        check.style.opacity = (option as HTMLElement).dataset.theme === preference ? '1' : '0';
      }
    });
  }

  function applyTheme(preference: string) {
    if (!ALL_OPTIONS_MAP[preference]) preference = 'auto';
    const cssTheme = resolvePreference(preference);
    document.documentElement.setAttribute('data-theme', cssTheme);
    localStorage.setItem('theme', preference);
    window.dispatchEvent(new CustomEvent('theme-changed', { detail: { preference, cssTheme } }));
  }

  // Listen for system preference changes to update auto theme in real-time
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const pref = getStoredPreference();
    if (pref === 'auto') {
      const cssTheme = resolvePreference('auto');
      document.documentElement.setAttribute('data-theme', cssTheme);
      window.dispatchEvent(
        new CustomEvent('theme-changed', { detail: { preference: 'auto', cssTheme } })
      );
    }
  });

  function toggleDropdown(show: boolean) {
    const dropdown = document.getElementById('theme-dropdown');
    const toggle = document.getElementById('theme-toggle');
    if (!dropdown || !toggle) return;

    if (show) {
      dropdown.classList.remove('opacity-0', 'invisible', 'translate-y-1');
      dropdown.classList.add('opacity-100', 'visible', 'translate-y-0');
      toggle.setAttribute('aria-expanded', 'true');
    } else {
      dropdown.classList.add('opacity-0', 'invisible', 'translate-y-1');
      dropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
      toggle.setAttribute('aria-expanded', 'false');
    }
  }

  // Event delegation for all clicks
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const themeToggle = target.closest('#theme-toggle');
    const themeDropdown = document.getElementById('theme-dropdown');
    const themeOption = target.closest('.theme-option') as HTMLElement | null;

    // Theme dropdown toggle
    if (themeToggle) {
      e.preventDefault();
      const isOpen = themeToggle.getAttribute('aria-expanded') === 'true';
      toggleDropdown(!isOpen);
      return;
    }

    // Theme option selection
    if (themeOption) {
      const newTheme = themeOption.dataset.theme;
      if (newTheme) {
        applyTheme(newTheme);
        toggleDropdown(false);
      }
      return;
    }

    // Close dropdown when clicking outside
    if (themeDropdown && !themeDropdown.contains(target)) {
      toggleDropdown(false);
    }

    // Mobile menu toggle
    const menuToggle = target.closest('#mobile-menu-toggle');
    if (menuToggle) {
      toggleMobileMenu();
    }

    // Close mobile menu on link click
    const mobileMenuLink = target.closest('#mobile-menu a');
    if (mobileMenuLink) {
      closeMobileMenu();
    }
  });

  function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobile-menu');
    const menuToggle = document.getElementById('mobile-menu-toggle');
    if (!mobileMenu || !menuToggle) return;

    const isOpen = !mobileMenu.classList.contains('hidden');
    if (isOpen) {
      closeMobileMenu();
    } else {
      openMobileMenu();
    }
  }

  function openMobileMenu() {
    const mobileMenu = document.getElementById('mobile-menu');
    const menuToggle = document.getElementById('mobile-menu-toggle');
    if (!mobileMenu || !menuToggle) return;

    mobileMenu.classList.remove('hidden');
    menuToggle.setAttribute('aria-expanded', 'true');
    menuToggle.setAttribute('aria-label', 'Close menu');

    // Focus first link in menu
    const firstLink = mobileMenu.querySelector('a');
    if (firstLink) firstLink.focus();
  }

  function closeMobileMenu(returnFocus = true) {
    const mobileMenu = document.getElementById('mobile-menu');
    const menuToggle = document.getElementById('mobile-menu-toggle');
    if (!mobileMenu || !menuToggle) return;

    mobileMenu.classList.add('hidden');
    menuToggle.setAttribute('aria-expanded', 'false');
    menuToggle.setAttribute('aria-label', 'Open menu');

    // Return focus to toggle button
    if (returnFocus) menuToggle.focus();
  }

  function isMobileMenuOpen() {
    const mobileMenu = document.getElementById('mobile-menu');
    return mobileMenu && !mobileMenu.classList.contains('hidden');
  }

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    // Close dropdowns/menus on escape
    if (e.key === 'Escape') {
      toggleDropdown(false);
      if (isMobileMenuOpen()) {
        closeMobileMenu();
      }
    }

    // Focus trap for mobile menu
    if (e.key === 'Tab' && isMobileMenuOpen()) {
      const mobileMenu = document.getElementById('mobile-menu');
      const menuToggle = document.getElementById('mobile-menu-toggle');
      if (!mobileMenu || !menuToggle) return;

      const focusableElements = [menuToggle, ...mobileMenu.querySelectorAll('a, button')];
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        (lastElement as HTMLElement).focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        (firstElement as HTMLElement).focus();
      }
    }
  });

  // Listen for theme changes
  window.addEventListener('theme-changed', (e) => {
    updateThemeUI((e as CustomEvent).detail.preference);
  });

  // Initialize theme on page load
  function initTheme() {
    const preference = getStoredPreference();
    applyTheme(preference);

    // Close mobile menu on navigation (without returning focus)
    closeMobileMenu(false);

    // Close theme dropdown
    toggleDropdown(false);
  }

  initTheme();
  document.addEventListener('astro:after-swap', initTheme);
</script>
