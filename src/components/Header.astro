---
import { GITHUB_PROFILE_LINK } from '../consts';

import GithubIcon from '../assets/icons/github.svg';
import ChevronDownIcon from '../assets/icons/chevron-down.svg';
import CheckIcon from '../assets/icons/check.svg';
import MenuIcon from '../assets/icons/menu.svg';

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/blog', label: 'Blog' },
  { href: '/#projects', label: 'Projects' },
  { href: '/#contact', label: 'Contact' },
];

const themes = [
  { id: 'cloud', label: 'Light', icon: '‚òÄÔ∏è' },
  { id: 'cloud-dark', label: 'Dark', icon: 'üåô' },
  { id: 'terminal', label: 'Terminal', icon: 'üíª' },
];

const currentPath = Astro.url.pathname;
---

<header class="fixed top-0 left-0 right-0 z-50 border-b border-line bg-background/80 backdrop-blur-xl">
  <div class="container">
    <nav class="flex items-center justify-between h-16" aria-label="Main navigation">
      <!-- Logo -->
      <a
        href="/"
        class="group flex items-center gap-2 font-display font-semibold text-foreground"
        aria-label="Ivan Kalinichenko - Home"
      >
        <span class="text-accent font-mono text-sm">~/</span>
        <span class="tracking-tight">kalinichenko</span>
        <span class="text-foreground-tertiary font-mono text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200">.dev</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-1">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class:list={[
              "px-4 py-2 text-sm font-medium rounded-md transition-colors duration-150",
              currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href.replace('/#', '/')))
                ? "text-foreground bg-background-subtle"
                : "text-foreground-secondary hover:text-foreground hover:bg-background-subtle"
            ]}
          >
            {link.label}
          </a>
        ))}
      </div>

      <!-- Right Side: Theme Switcher + GitHub -->
      <div class="flex items-center gap-2">
        <!-- GitHub Link -->
        <a
          href={GITHUB_PROFILE_LINK}
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 text-foreground-tertiary hover:text-foreground transition-colors duration-150"
          aria-label="GitHub Profile"
        >
          <GithubIcon class="w-5 h-5" />
        </a>

        <!-- Theme Switcher -->
        <div class="relative">
          <button
            id="theme-toggle"
            type="button"
            class="flex items-center gap-1.5 px-2.5 py-1.5 text-sm text-foreground-tertiary hover:text-foreground border border-line rounded-md transition-colors duration-150 cursor-pointer hover:bg-background-subtle"
            aria-label="Change theme"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span id="theme-icon" class="text-base">‚òÄÔ∏è</span>
            <ChevronDownIcon class="w-3.5 h-3.5" />
          </button>

          <!-- Theme Dropdown -->
          <div
            id="theme-dropdown"
            class="absolute right-0 top-full mt-2 w-44 py-1.5 bg-surface border border-line rounded-lg shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 z-50"
            role="menu"
          >
            {themes.map((theme) => (
              <button
                type="button"
                class="theme-option w-full flex items-center gap-3 px-3 py-2 text-sm text-foreground-secondary hover:text-foreground hover:bg-background-subtle transition-colors cursor-pointer"
                data-theme={theme.id}
                role="menuitem"
              >
                <span class="text-base">{theme.icon}</span>
                <span>{theme.label}</span>
                <CheckIcon class="theme-check w-4 h-4 ml-auto text-accent opacity-0" />
              </button>
            ))}
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-toggle"
          type="button"
          class="md:hidden p-2 text-foreground-tertiary hover:text-foreground transition-colors duration-150 cursor-pointer"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <MenuIcon class="w-5 h-5" />
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Navigation -->
  <div
    id="mobile-menu"
    class="md:hidden hidden border-t border-line bg-background"
    aria-label="Mobile navigation"
  >
    <div class="container py-4 space-y-1">
      {navLinks.map((link) => (
        <a
          href={link.href}
          class:list={[
            "block px-4 py-3 text-sm font-medium rounded-md transition-colors duration-150",
            currentPath === link.href
              ? "text-foreground bg-background-subtle"
              : "text-foreground-secondary hover:text-foreground hover:bg-background-subtle"
          ]}
        >
          {link.label}
        </a>
      ))}
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-16" aria-hidden="true"></div>

<script is:inline>
  (function() {
    // Prevent multiple initializations
    if (window.__headerInitialized) return;
    window.__headerInitialized = true;

    // Theme configuration
    const THEMES = {
      'cloud': { icon: '‚òÄÔ∏è', label: 'Light' },
      'cloud-dark': { icon: 'üåô', label: 'Dark' },
      'terminal': { icon: 'üíª', label: 'Terminal' }
    };

    const DEFAULT_THEME = 'cloud';

    function getStoredTheme() {
      return localStorage.getItem('theme');
    }

    function getSystemPreference() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'cloud-dark' : 'cloud';
    }

    function updateThemeUI(theme) {
      // Update button icon
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon && THEMES[theme]) {
        themeIcon.textContent = THEMES[theme].icon;
      }

      // Update checkmarks in dropdown
      document.querySelectorAll('.theme-option').forEach(option => {
        const check = option.querySelector('.theme-check');
        if (check) {
          check.style.opacity = option.dataset.theme === theme ? '1' : '0';
        }
      });
    }

    function applyTheme(theme) {
      if (!THEMES[theme]) theme = DEFAULT_THEME;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeUI(theme);
    }

    function toggleDropdown(show) {
      const dropdown = document.getElementById('theme-dropdown');
      const toggle = document.getElementById('theme-toggle');
      if (!dropdown || !toggle) return;

      if (show) {
        dropdown.classList.remove('opacity-0', 'invisible', 'translate-y-1');
        dropdown.classList.add('opacity-100', 'visible', 'translate-y-0');
        toggle.setAttribute('aria-expanded', 'true');
      } else {
        dropdown.classList.add('opacity-0', 'invisible', 'translate-y-1');
        dropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
        toggle.setAttribute('aria-expanded', 'false');
      }
    }

    // Event delegation for all clicks
    document.addEventListener('click', (e) => {
      const themeToggle = e.target.closest('#theme-toggle');
      const themeDropdown = document.getElementById('theme-dropdown');
      const themeOption = e.target.closest('.theme-option');

      // Theme dropdown toggle
      if (themeToggle) {
        e.preventDefault();
        const isOpen = themeToggle.getAttribute('aria-expanded') === 'true';
        toggleDropdown(!isOpen);
        return;
      }

      // Theme option selection
      if (themeOption) {
        const newTheme = themeOption.dataset.theme;
        if (newTheme) {
          applyTheme(newTheme);
          toggleDropdown(false);
        }
        return;
      }

      // Close dropdown when clicking outside
      if (themeDropdown && !themeDropdown.contains(e.target)) {
        toggleDropdown(false);
      }

      // Mobile menu toggle
      const menuToggle = e.target.closest('#mobile-menu-toggle');
      if (menuToggle) {
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu) {
          const isOpen = !mobileMenu.classList.contains('hidden');
          mobileMenu.classList.toggle('hidden');
          menuToggle.setAttribute('aria-expanded', String(!isOpen));
        }
      }

      // Close mobile menu on link click
      const mobileMenuLink = e.target.closest('#mobile-menu a');
      if (mobileMenuLink) {
        const mobileMenu = document.getElementById('mobile-menu');
        const menuToggle = document.getElementById('mobile-menu-toggle');
        if (mobileMenu) mobileMenu.classList.add('hidden');
        if (menuToggle) menuToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // Close dropdown on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        toggleDropdown(false);
      }
    });

    // Initialize theme on page load
    function initTheme() {
      const storedTheme = getStoredTheme();
      const theme = storedTheme || getSystemPreference();
      applyTheme(theme);

      // Close mobile menu on navigation
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) mobileMenu.classList.add('hidden');

      // Close theme dropdown
      toggleDropdown(false);
    }

    initTheme();
    document.addEventListener('astro:after-swap', initTheme);
  })();
</script>
