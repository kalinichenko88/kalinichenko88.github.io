---
import { Font } from 'astro:assets';

import Header from './Header.astro';
import Footer from './Footer.astro';
import Head from './Head.astro';

import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { THEME_IDS, DEFAULT_LIGHT_THEME, DEFAULT_DARK_THEME } from '../config/themes';

import '../styles/global.css';

type Props = {
  title?: string;
  description?: string;
  class?: string;
};

const { title = SITE_TITLE, description = SITE_DESCRIPTION, class: className } = Astro.props;

const themeConfig = JSON.stringify({
  ids: THEME_IDS,
  lightDefault: DEFAULT_LIGHT_THEME,
  darkDefault: DEFAULT_DARK_THEME,
});
---

<!doctype html>
<html lang="en">
  <head>
    <!-- Theme initialization - must be first to prevent flash -->
    <script is:inline data-theme-config={themeConfig}>
      (function () {
        const config = JSON.parse(document.currentScript.dataset.themeConfig);

        function getTheme() {
          let theme = localStorage.getItem('theme');
          if (!theme || !config.ids.includes(theme)) {
            theme = window.matchMedia('(prefers-color-scheme: dark)').matches
              ? config.darkDefault
              : config.lightDefault;
          }
          return theme;
        }

        // Apply theme immediately on initial load
        document.documentElement.setAttribute('data-theme', getTheme());

        // Handle View Transitions - apply theme BEFORE swap to prevent flash
        document.addEventListener('astro:before-swap', (e) => {
          e.newDocument.documentElement.setAttribute('data-theme', getTheme());
        });
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <Head title={title} description={description} />

    <!-- Fonts -->
    <Font cssVariable="--font-general-sans" preload />
    <Font cssVariable="--font-dm-sans" preload />
    <Font cssVariable="--font-jetbrains-mono" preload />
  </head>
  <body class="min-h-screen flex flex-col bg-background text-foreground antialiased">
    <Header />

    <main class:list={['flex-1', className]}>
      <slot />
    </main>

    <Footer />
  </body>
</html>
