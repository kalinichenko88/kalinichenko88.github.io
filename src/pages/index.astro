---
import { getCollection } from 'astro:content';

import Layout from '../components/Layout.astro';
import HeroSection from '../components/home/HeroSection.astro';
import AboutSection from '../components/home/AboutSection.astro';
import ProjectsSection from '../components/home/ProjectsSection.astro';
import BlogSection from '../components/home/BlogSection.astro';
import ContactSection from '../components/home/ContactSection.astro';

import {
  AUTHOR_NAME,
  ROLE,
  GITHUB_PROFILE_LINK,
  LINKEDIN_PROFILE_LINK,
  MAIL_PROFILE_LINK,
  TWITTER_PROFILE_LINK,
} from '../consts';

const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: AUTHOR_NAME,
  jobTitle: ROLE,
  url: 'https://kalinichenko.dev',
  sameAs: [GITHUB_PROFILE_LINK, LINKEDIN_PROFILE_LINK, TWITTER_PROFILE_LINK],
  knowsAbout: ['React', 'TypeScript', 'JavaScript', 'Frontend Architecture', 'Web Performance'],
};

const allPosts = await getCollection('posts');
const latestPosts = allPosts
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
  .slice(0, 3);

const featuredProjects = await getCollection('projects');
const githubRepos = await getCollection('githubRepos');
const repoMap = new Map(githubRepos.map((repo) => [repo.data.name, repo]));

const projects = featuredProjects
  .sort((a, b) => a.data.order - b.data.order)
  .map((project) => {
    const githubRepo = repoMap.get(project.data.slug);

    if (!githubRepo) {
      throw new Error(
        `GitHub repository "${project.data.slug}" not found for project "${project.data.name}". ` +
          `Make sure the slug matches the GitHub repository name exactly.`
      );
    }

    return {
      name: project.data.name,
      slug: project.data.slug,
      order: project.data.order,
      description: githubRepo.data.description,
      url: githubRepo.data.html_url,
      homepage: githubRepo.data.homepage,
      stars: githubRepo.data.stargazers_count,
      forks: githubRepo.data.forks_count,
      language: githubRepo.data.language,
      topics: githubRepo.data.topics,
    };
  });

const expertise = [
  {
    category: 'Frontend Core',
    skills: ['React', 'TypeScript', 'JavaScript', 'Next.js', 'Vue.js'],
  },
  {
    category: 'Architecture & DX',
    skills: ['Frontend Architecture', 'Performance', 'CI/CD', 'Testing', 'Webpack'],
  },
  {
    category: 'Full-Stack',
    skills: ['Node.js', 'GraphQL', 'REST APIs', 'PHP', 'SQL'],
  },
  {
    category: 'Tools & Practices',
    skills: ['Git', 'Docker', 'Agile', 'Code Review', 'Remote Teams'],
  },
];
---

<Layout>
  <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
  <HeroSection />
  <AboutSection expertise={expertise} />
  <ProjectsSection projects={projects} githubProfileLink={GITHUB_PROFILE_LINK} />
  {
    allPosts.length > 0 && (
      <BlogSection latestPosts={latestPosts} githubProfileLink={GITHUB_PROFILE_LINK} />
    )
  }
  <ContactSection mailProfileLink={MAIL_PROFILE_LINK} linkedinProfileLink={LINKEDIN_PROFILE_LINK} />
</Layout>
